<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vigilare | Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
    <style>
        :root {
            --bg-void: #0a0a0a;
            --bg-highlight: #141414;
            --border-color: #262626;
            --text-main: #f0f0f0;
            --text-muted: #a1a1a1;
            --text-accent: #00eda0;
            --danger: #ff4444;
            --warn: #ffaa00;
            --radius: 12px;
        }
        
        body { 
            background-color: var(--bg-void); 
            color: var(--text-main); 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; 
            padding: 40px; 
            font-size: 14px; 
        }

        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 40px; 
            padding-bottom: 20px; 
            border-bottom: 1px solid var(--border-color); 
        }
        
        .logo {
            font-family: "Didot", serif;
            font-size: 2.2rem;
            font-weight: 800; 
            color: var(--text-main);
            letter-spacing: -1.5px; 
        }
        .logo span { 
            color: var(--text-accent);
            text-shadow: 0 0 20px rgba(0, 237, 160, 0.4);
            margin-left: -1px;
        }
        .subtitle { font-family: 'Inter', sans-serif; font-size: 1rem; color: var(--text-muted); font-weight: 400; letter-spacing: 0; margin-left: 10px; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 24px; }
        .split-grid { display: grid; grid-template-columns: 350px 1fr; gap: 24px; }

        .panel { 
            background: var(--bg-highlight); 
            padding: 24px; 
            border-radius: var(--radius); 
            border: 1px solid var(--border-color); 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
            transition: border-color 0.2s;
        }
        .panel:hover { border-color: #333; }

        .panel h2 { 
            margin: 0 0 15px 0; 
            font-size: 0.85rem; 
            color: var(--text-muted); 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            font-weight: 600; 
        }

        .metric-big { font-size: 2.8rem; font-weight: 700; color: #fff; line-height: 1; margin-bottom: 5px; letter-spacing: -1px; }
        .metric-sub { font-size: 0.9rem; color: var(--text-muted); }
        .est-vol { margin-top: 8px; color: var(--text-accent); font-weight: 500; font-size: 0.9rem; }

        .storage-row { 
            display: flex; justify-content: space-between; 
            margin-bottom: 10px; 
            border-bottom: 1px solid #1a1a1a; 
            padding-bottom: 6px; 
        }
        .storage-label { color: var(--text-muted); font-size: 0.9rem; }
        .storage-val { font-family: monospace; font-weight: 600; color: #fff; }
        .warn { color: var(--warn); }

        .prog-track { width: 100%; height: 4px; background: #222; border-radius: 2px; margin-top: 4px; margin-bottom: 16px; }
        .prog-fill { height: 100%; background: var(--text-accent); border-radius: 2px; width: 0%; transition: width 0.5s ease; box-shadow: 0 0 10px rgba(0, 237, 160, 0.2); }

        .chart-container { position: relative; height: 280px; width: 100%; margin-top: 10px; }
        
        @media (max-width: 1000px) {
            .split-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">vigilare<span>.</span> <span class="subtitle">Dashboard</span></div>
        </div>

    <div class="grid">
        <div class="panel">
            <h2>Crawl Velocity (Avg 1m)</h2>
            <div class="metric-big" id="ppm">--</div>
            <div class="metric-sub">Pages Per Minute</div>
            <div class="est-vol">Est: <span id="daily-vol">0</span> / 24h</div>
        </div>

        <div class="panel">
            <h2>Queue Health</h2>
            <div class="metric-big" id="q-active">0</div>
            <div class="metric-sub">Active Threads</div>
            <div style="margin-top: 20px;">
                <div class="storage-row"><span class="storage-label">Pending URLs</span> <span class="storage-val" id="q-pending">0</span></div>
                <div class="storage-row" style="border:none;"><span class="storage-label">Errors / Retries</span> <span class="storage-val warn" id="q-retries">0</span></div>
            </div>
        </div>

        <div class="panel">
            <h2>Total Progress</h2>
            <div class="metric-big" id="total-visited">0</div>
            <div class="metric-sub">Pages Crawled</div>
            <div style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                <div class="storage-row" style="border:none; margin:0;">
                    <span class="storage-label">Indexed & Searchable</span>
                    <span class="storage-val" id="total-indexed" style="color: #fff;">0</span>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>System Load</h2>
            
            <div style="margin-bottom: 5px;">
                <div class="storage-row" style="border:none; margin:0; padding:0;">
                    <span class="storage-label">CPU</span> <span class="storage-val" id="sys-cpu">0%</span>
                </div>
                <div class="prog-track"><div class="prog-fill" id="bar-cpu"></div></div>
            </div>

            <div style="margin-bottom: 5px;">
                <div class="storage-row" style="border:none; margin:0; padding:0;">
                    <span class="storage-label">RAM</span> <span class="storage-val" id="sys-ram">0%</span>
                </div>
                <div class="prog-track"><div class="prog-fill" id="bar-ram"></div></div>
            </div>

            <div>
                <div class="storage-row" style="border:none; margin:0; padding:0;">
                    <span class="storage-label">Disk</span> <span class="storage-val" id="sys-disk">0%</span>
                </div>
                <div class="prog-track"><div class="prog-fill" id="bar-disk"></div></div>
            </div>
        </div>
    </div>

    <div class="split-grid">
        <div class="panel">
            <h2>Database Storage</h2>
            
            <div class="storage-row"><span class="storage-label" style="color:#fff">CRAWL DB</span> <span class="storage-val" id="sz-crawl-db">0.0 MB</span></div>
            <div class="storage-row"><span>↳ WAL Buffer</span> <span class="storage-val" id="sz-crawl-wal">0.0 MB</span></div>
            
            <div class="storage-row" style="margin-top:20px"><span class="storage-label" style="color:#fff">STORAGE DB</span> <span class="storage-val" id="sz-store-db">0.0 MB</span></div>
            <div class="storage-row"><span>↳ WAL Buffer</span> <span class="storage-val" id="sz-store-wal">0.0 MB</span></div>

            <div class="storage-row" style="margin-top:20px"><span class="storage-label" style="color:#fff">SEARCH DB</span> <span class="storage-val" id="sz-search-db">0.0 MB</span></div>
            <div class="storage-row" style="border:none;"><span>↳ WAL Buffer</span> <span class="storage-val" id="sz-search-wal">0.0 MB</span></div>
        </div>

        <div class="panel">
            <h2>Performance History (Avg PPM)</h2>
            <div class="chart-container">
                <canvas id="speedChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        const HISTORY_SECONDS = 300;
        
        let chart = null;
        const statsHistory = []; 
        const WINDOW_MS = HISTORY_SECONDS * 1000; 

        window.addEventListener('load', function() {
            try {
                if (typeof Chart === 'undefined') {
                    document.getElementById('chart-error').style.display = 'block';
                    return;
                }
                const ctx = document.getElementById('speedChart').getContext('2d');
                
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(0, 237, 160, 0.2)');
                gradient.addColorStop(1, 'rgba(0, 237, 160, 0)');

                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array(HISTORY_SECONDS).fill(""),
                        datasets: [{
                            label: 'Avg PPM',
                            data: Array(HISTORY_SECONDS).fill(0),
                            borderColor: '#00eda0',
                            backgroundColor: gradient,
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { display: false },
                            y: { beginAtZero: true, grid: { color: '#222' }, suggestedMax: 100 }
                        },
                        animation: false, 
                        interaction: { intersect: false, mode: 'index' }
                    }
                });
            } catch (e) {
                console.error("Chart Init Error:", e);
                document.getElementById('chart-error').style.display = 'block';
            }
        });

        function safeUpdate(id, val) { const el = document.getElementById(id); if(el) el.innerText = val; }
        function formatNum(n) { return (n || 0).toLocaleString(); }
        function formatMB(n) { return (n || 0).toFixed(1) + " MB"; }
        function updateBar(id, val) { const el = document.getElementById(id); if(el) el.style.width = val + "%"; }

        function fetchStats() {
            fetch('/api/stats')
                .then(r => r.json())
                .then(data => {
                    const c = data.counts || {};
                    const q = c.queue || {};
                    const s = data.storage || {};
                    const sys = data.system || {};

                    const currentVisited = c.visited || 0;
                    if (statsHistory.length > 0 && currentVisited < statsHistory[statsHistory.length-1].v) {
                        return;
                    }

                    safeUpdate('total-visited', formatNum(c.visited));
                    safeUpdate('total-indexed', formatNum(c.indexed));
                    safeUpdate('q-active', formatNum(q.active));
                    safeUpdate('q-pending', formatNum(q.pending));
                    safeUpdate('q-retries', formatNum(c.retries));

                    safeUpdate('sys-cpu', (sys.cpu || 0) + "%"); updateBar('bar-cpu', sys.cpu || 0);
                    safeUpdate('sys-ram', (sys.ram || 0) + "%"); updateBar('bar-ram', sys.ram || 0);
                    safeUpdate('sys-disk', (sys.disk || 0) + "%"); updateBar('bar-disk', sys.disk || 0);

                    if(s.crawl) { safeUpdate('sz-crawl-db', formatMB(s.crawl.db)); safeUpdate('sz-crawl-wal', formatMB(s.crawl.wal)); }
                    if(s.storage) { safeUpdate('sz-store-db', formatMB(s.storage.db)); safeUpdate('sz-store-wal', formatMB(s.storage.wal)); }
                    if(s.search) { safeUpdate('sz-search-db', formatMB(s.search.db)); safeUpdate('sz-search-wal', formatMB(s.search.wal)); }

                    const now = Date.now();
                    statsHistory.push({ t: now, v: currentVisited });

                    while (statsHistory.length > 0 && (now - statsHistory[0].t > WINDOW_MS)) {
                        statsHistory.shift();
                    }

                    let ppm = 0;
                    if (statsHistory.length > 1) {
                        const start = statsHistory[0];
                        const end = statsHistory[statsHistory.length - 1];
                        const deltaMs = end.t - start.t;
                        const deltaPages = end.v - start.v;

                        if (deltaMs > 5000 && deltaPages >= 0) {
                            ppm = Math.round((deltaPages / deltaMs) * 60000);
                        }
                    }

                    safeUpdate('ppm', formatNum(ppm));
                    safeUpdate('daily-vol', formatNum(ppm * 60 * 24));

                    if (chart) {
                        chart.data.labels.shift(); chart.data.labels.push("");
                        chart.data.datasets[0].data.shift(); chart.data.datasets[0].data.push(ppm);
                        chart.update();
                    }
                })
                .catch(console.error);
        }

        setInterval(fetchStats, 1000);
        fetchStats();
    </script>
</body>
</html>